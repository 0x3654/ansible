- name: AmneziaWG Create and get AmneziaWG client configuration
  tags: [amneziawg]
  block:
    - name: AmneziaWG Create directory for client configurations
      ansible.builtin.file:
        path: "{{ vpnserver_amneziawg_path }}/clients"
        state: directory
        mode: '0755'

    - name: AmneziaWG Check if client configuration already exists
      ansible.builtin.stat:
        path: "{{ vpnserver_amneziawg_path }}/clients/awg.conf"
      register: vpnserver_client_config_file

    - name: AmneziaWG Check if local client configuration exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../configs/awg_{{ domain_name }}.conf"
      delegate_to: localhost
      register: vpnserver_local_config_file
      run_once: true

    - name: AmneziaWG API add client and download .conf
      when: not vpnserver_client_config_file.stat.exists
      block:
        - name: Authenticate with WireGuard API
          ansible.builtin.uri:
            url: "http://localhost:{{ vpnserver_amneziawg_port }}/api/session"
            method: POST
            body_format: json
            body:
              password: "{{ vpnserver_amneziawg_password }}"
            status_code: [200]
            return_content: true
          register: vpnserver_auth_response

        - name: Extract session cookie from auth response
          ansible.builtin.set_fact:
            vpnserver_amneziawg_session_cookie: "{{ vpnserver_auth_response.cookies_string | default('') }}"

    - name: AmneziaWG API operations
      when: not vpnserver_client_config_file.stat.exists and vpnserver_amneziawg_session_cookie is defined and vpnserver_amneziawg_session_cookie != ''
      block:
        - name: AmneziaWG Get list of clients
          ansible.builtin.uri:
            url: "http://localhost:{{ vpnserver_amneziawg_port }}/api/wireguard/client"
            method: GET
            status_code: [200, 500]
            return_content: true
            headers:
              Cookie: "{{ vpnserver_amneziawg_session_cookie }}"
          register: vpnserver_clients_response
          retries: 2
          delay: 2
          until: vpnserver_clients_response.status == 200 or vpnserver_clients_response.status == 500

        - name: Check if awg client already exists
          ansible.builtin.set_fact:
            vpnserver_client_exists: "{{ (vpnserver_clients_response.json | selectattr('name', 'equalto', 'awg') | list) | length > 0 }}"
            vpnserver_client_id: >-
              {{ (vpnserver_clients_response.json | selectattr('name', 'equalto', 'awg') | list)[0].id
              if (vpnserver_clients_response.json | selectattr('name', 'equalto', 'awg') | list) | length > 0 else '' }}

        - name: AmneziaWG Create new WireGuard client
          when: not vpnserver_client_exists
          ansible.builtin.uri:
            url: "http://localhost:{{ vpnserver_amneziawg_port }}/api/wireguard/client"
            method: POST
            body_format: json
            body:
              name: "awg"
            status_code: [200]
            return_content: true
            headers:
              Cookie: "{{ vpnserver_amneziawg_session_cookie }}"
          register: vpnserver_create_response
          retries: 3
          delay: 2
          until: vpnserver_create_response.status == 200

        - name: Wait for 1 second after client creation
          when: vpnserver_create_response is defined
          ansible.builtin.pause:
            seconds: 1

        - name: AmneziaWG Get updated list of clients if new client was created
          when: vpnserver_create_response is defined
          ansible.builtin.uri:
            url: "http://localhost:{{ vpnserver_amneziawg_port }}/api/wireguard/client"
            method: GET
            status_code: 200
            return_content: true
            headers:
              Cookie: "{{ vpnserver_amneziawg_session_cookie }}"
          register: vpnserver_updated_clients_response

        - name: Extract client ID for awg after creation
          when: vpnserver_updated_clients_response is defined
          ansible.builtin.set_fact:
            vpnserver_client_id: "{{ (vpnserver_updated_clients_response.json | selectattr('name', 'equalto', 'awg') | list)[0].id }}"

        - name: Wait for 2 seconds before getting client configuration
          when: vpnserver_client_id is defined and vpnserver_client_id != ''
          ansible.builtin.pause:
            seconds: 2

        - name: AmneziaWG Get client configuration
          when: vpnserver_client_id is defined and vpnserver_client_id != ''
          ansible.builtin.uri:
            url: "http://localhost:{{ vpnserver_amneziawg_port }}/api/wireguard/client/{{ vpnserver_client_id }}/configuration"
            method: GET
            status_code: 200
            return_content: true
            headers:
              Cookie: "{{ vpnserver_amneziawg_session_cookie }}"
          register: vpnserver_config_response

        - name: Close AmneziaWG API session
          when: vpnserver_amneziawg_session_cookie is defined and vpnserver_amneziawg_session_cookie != ''
          ansible.builtin.uri:
            url: "http://localhost:{{ vpnserver_amneziawg_port }}/api/session"
            method: DELETE
            status_code: [200, 204]
            headers:
              Cookie: "{{ vpnserver_amneziawg_session_cookie }}"

    - name: AmneziaWG Save client configuration on server
      when: not vpnserver_client_config_file.stat.exists and vpnserver_config_response is defined and vpnserver_config_response.content is defined
      ansible.builtin.copy:
        content: "{{ vpnserver_config_response.content }}"
        dest: "{{ vpnserver_amneziawg_path }}/clients/awg.conf"
        mode: '0600'

    - name: AmneziaWG Check if new client configuration exists
      ansible.builtin.stat:
        path: "{{ vpnserver_amneziawg_path }}/clients/awg.conf"
      register: vpnserver_new_client_config_file

    - name: AmneziaWG Download client configuration to main host
      when: not vpnserver_local_config_file.stat.exists and vpnserver_new_client_config_file.stat.exists
      ansible.builtin.fetch:
        src: "{{ vpnserver_amneziawg_path }}/clients/awg.conf"
        dest: "{{ playbook_dir }}/../configs/awg_{{ domain_name }}.conf"
        flat: true
