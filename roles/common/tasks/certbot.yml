- name: SSL Certificate Management
  block:
    - name: SSL Check if certificate already exists
      ansible.builtin.stat:
        path: "{{ cert_path }}/live/{{ common_domain_name | default(domain_name) }}/fullchain.pem"
      register: common_ssl_cert_exists

    - name: Check if certificate exists and is not empty
      ansible.builtin.set_fact:
        common_ssl_cert_valid: "{{ common_ssl_cert_exists.stat.exists and common_ssl_cert_exists.stat.size > 0 }}"

    - name: Check certificate expiration date
      when: common_ssl_cert_valid
      ansible.builtin.shell: |
        set -o pipefail
        openssl x509 -in {{ cert_path }}/live/{{ common_domain_name | default(domain_name) }}/fullchain.pem -noout -enddate | cut -d= -f2
      args:
        executable: /bin/bash
      register: common_cert_expiration
      changed_when: false

    - name: Convert expiration date to timestamp
      when: common_ssl_cert_valid and common_cert_expiration is defined and common_cert_expiration.stdout is defined
      ansible.builtin.command: date -d "{{ common_cert_expiration.stdout }}" +%s
      register: common_expiration_timestamp
      failed_when: false
      changed_when: false

    - name: Get current timestamp
      when: common_ssl_cert_valid and common_expiration_timestamp is defined and common_expiration_timestamp.stdout is defined
      ansible.builtin.command: date +%s
      register: common_current_timestamp
      changed_when: false

    - name: Calculate days until expiration
      when:
        - common_ssl_cert_valid
        - common_expiration_timestamp is defined
        - common_expiration_timestamp.stdout is defined
        - common_current_timestamp is defined
        - common_current_timestamp.stdout is defined
      ansible.builtin.set_fact:
        common_days_until_expiration: "{{ ((common_expiration_timestamp.stdout | int - common_current_timestamp.stdout | int) / 86400) | int }}"

    - name: Set certificate needs renewal flag
      when: common_ssl_cert_valid
      ansible.builtin.set_fact:
        common_cert_needs_renewal: "{{ not common_ssl_cert_valid or (common_days_until_expiration is defined and common_days_until_expiration | int <= 30) }}"

- name: SSL Certificate Management only when SSL certificate not exists or invalid
  when: not common_ssl_cert_exists.stat.exists or not common_ssl_cert_valid or common_cert_needs_renewal
  notify:
    - '{{ common_down_handler_name }}'
    - '{{ common_up_handler_name }}'
  tags: [ssl]
  block:
    - name: Temporarily open port 80 for certbot
      ansible.builtin.include_tasks: firewall.yml
      vars:
        common_required_rules:
          - "-A INPUT -p tcp --dport 80 -j ACCEPT"

    - name: Run certbot to obtain certificate
      ansible.builtin.shell: >
        certbot certonly --standalone
        --config-dir {{ cert_path }}/
        --work-dir {{ cert_path }}/
        -d {{ common_domain_name | default(domain_name) }}
        --non-interactive
        --agree-tos
        --register-unsafely-without-email
        -v
      register: common_certbot_result
      changed_when: true
      failed_when: common_certbot_result.rc != 0

    - name: Close port 80 after certbot
      ansible.builtin.include_tasks: firewall.yml
      vars:
        common_prohibited_rules:
          - "-A INPUT -p tcp --dport 80 -j ACCEPT"
