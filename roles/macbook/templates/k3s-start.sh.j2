#!/bin/bash
# Start K3s cluster with k3d

CLUSTER_NAME="{{ macbook_k3d_cluster_name }}"
AGENTS={{ macbook_k3d_cluster_agents }}
API_PORT={{ macbook_k3d_api_port }}
LB_PORT={{ macbook_k3d_lb_port }}

echo "ğŸš€ Starting K3s cluster: $CLUSTER_NAME"

# Check if cluster already exists
if k3d cluster list | grep -q "$CLUSTER_NAME"; then
  echo "âœ… Cluster '$CLUSTER_NAME' already exists"
  echo "ğŸ”„ Starting cluster..."
  k3d cluster start "$CLUSTER_NAME"
else
  echo "ğŸ“¦ Creating new cluster with $AGENTS agents..."
  k3d cluster create "$CLUSTER_NAME" \
    --agents "$AGENTS" \
    -p "${LB_PORT}:80@loadbalancer" \
    --api-port "$API_PORT"
fi

echo ""
echo "âœ… Cluster is running!"
echo ""
echo "ğŸ”§ Kubeconfig:"
echo "export KUBECONFIG=\"\$(k3d kubeconfig write $CLUSTER_NAME)\""
echo ""
echo "ğŸ“Š Cluster info:"
kubectl cluster-info
echo ""
echo "ğŸ” Nodes:"
kubectl get nodes
