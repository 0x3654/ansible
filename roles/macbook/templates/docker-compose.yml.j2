version: '3.8'

services:
  # Redis
  redis:
    image: redis:8-alpine
    container_name: devops-redis
    restart: unless-stopped
    ports:
      - "{{ macbook_devops_ports.redis }}:6379"
    volumes:
      - {{ macbook_devops_dir }}/data/redis:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: devops-postgres
    restart: unless-stopped
    ports:
      - "{{ macbook_devops_ports.postgres }}:5432"
    environment:
      POSTGRES_USER: {{ macbook_devops_db_user }}
      POSTGRES_PASSWORD: {{ macbook_devops_db_password }}
      POSTGRES_DB: {{ macbook_devops_db_name }}
    volumes:
      - {{ macbook_devops_dir }}/data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ macbook_devops_db_user }}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Gitea
  gitea:
    image: gitea/gitea:latest
    container_name: devops-gitea
    restart: unless-stopped
    ports:
      - "{{ macbook_devops_ports.gitea_http }}:3000"
      - "{{ macbook_devops_ports.gitea_ssh }}:22"
    environment:
      - USER_UID={{ macbook_gitea_user_uid }}
      - USER_GID={{ macbook_gitea_user_gid }}
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres:5432
      - GITEA__database__NAME=gitea
      - GITEA__database__USER={{ macbook_devops_db_user }}
      - GITEA__database__PASSWD={{ macbook_devops_db_password }}
    volumes:
      - {{ macbook_devops_dir }}/data/gitea:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      postgres:
        condition: service_healthy

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: devops-prometheus
    restart: unless-stopped
    ports:
      - "{{ macbook_devops_ports.prometheus }}:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - {{ macbook_devops_dir }}/data/prometheus:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: devops-grafana
    restart: unless-stopped
    ports:
      - "{{ macbook_devops_ports.grafana }}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER={{ macbook_grafana_admin_user }}
      - GF_SECURITY_ADMIN_PASSWORD={{ macbook_grafana_admin_password }}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:{{ macbook_devops_ports.grafana }}
    volumes:
      - {{ macbook_devops_dir }}/data/grafana:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus

  # K3s Server - DISABLED on macOS Docker Desktop
  # K3s cannot run in Docker Desktop on macOS due to Unix socket limitations
  # Use k3d, minikube, or kind locally, or install K3s on remote servers (micro/nano)
  # See ~/code/devops/README.md for alternatives

networks:
  k3s-net:
    driver: bridge


