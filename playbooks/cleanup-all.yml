---
- name: Cleanup Docker and server directory
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false
  become: true

  tasks:
    - name: Get all container IDs
      ansible.builtin.command: docker ps -aq
      register: container_ids
      changed_when: false

    - name: Remove all containers
      ansible.builtin.command: docker rm -f {{ item }}
      loop: "{{ container_ids.stdout_lines }}"
      when: container_ids.stdout != ""
      changed_when: true
      loop_control:
        label: "Container {{ item }}"

    - name: Remove server directory
      ansible.builtin.file:
        path: /server
        state: absent
      register: server_cleanup
      changed_when: true

    - name: Remove Docker images
      ansible.builtin.shell: docker rmi $(docker images -q) || true
      args:
        executable: /bin/bash
      changed_when: false
      failed_when: false
      tags: [docker, cleanup, images]

    - name: Check server directory
      ansible.builtin.stat:
        path: /server
      register: server_dir
      tags: [cleanup]

    - name: Display cleanup status
      ansible.builtin.debug:
        msg: "Folder /server {{ 'exist ERROR!' if server_dir.stat.exists else 'cleanup complite' }}"
      tags: [cleanup]
