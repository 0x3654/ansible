---
- name: Cleanup When Low on Disk Space
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  vars:
    disk_path: /
    max_usage_percent: 60
    log_dirs:
      - /var/log
      - /var/log/journal
    temp_dirs:
      - /tmp
      - /var/tmp
    log_age_days: 30
    temp_age_days: 15

  tasks:
    - name: Cleanup block
      when: "'vpnserver_role' in group_names"
      block:
        - name: Gather installed package facts
          ansible.builtin.package_facts:
            manager: auto

        - name: Get disk usage before cleanup
          ansible.builtin.shell: |
            set -o pipefail
            df -P {{ disk_path }} | awk 'NR==2 {gsub(/%/, "", $5); print $5}'
          register: disk_usage_before
          changed_when: false
          args:
            executable: /bin/bash

        - name: Show disk usage before
          ansible.builtin.debug:
            msg: "Disk usage before: {{ disk_usage_before.stdout }}%"

        - name: Cleanup if threshold exceeded
          when: (disk_usage_before.stdout | int) > max_usage_percent
          block:
            - name: Clean journalctl logs
              ansible.builtin.command: journalctl --vacuum-time={{ log_age_days }}d
              when: ansible_facts.os_family in ['Debian', 'RedHat']
              changed_when: false

            - name: Clean apt cache and autoremove packages
              ansible.builtin.apt:
                autoclean: true
                autoremove: true
              when: ansible_facts.pkg_mgr == 'apt'

            - name: Clean dnf cache and autoremove packages
              ansible.builtin.dnf:
                autoremove: true
              when: ansible_facts.pkg_mgr == 'dnf'

            - name: Run apt-get clean
              ansible.builtin.apt:
                clean: true
              when: ansible_facts.pkg_mgr == 'apt'

            - name: Remove junk directories from /root
              ansible.builtin.file:
                path: "{{ item }}"
                state: absent
              loop:
                - /root/.trae-server
                - /root/.cursor-server
                - /root/.zed_server

            - name: Find old logs
              ansible.builtin.find:
                paths: "{{ item }}"
                age: "{{ log_age_days }}d"
                recurse: true
                file_type: file
              loop: "{{ log_dirs }}"
              register: old_logs

            - name: Delete old logs
              no_log: true
              ansible.builtin.file:
                path: "{{ item.path }}"
                state: absent
              loop: "{{ old_logs.results | map(attribute='files') | sum(start=[]) }}"

            - name: Find old temp files
              no_log: true
              ansible.builtin.find:
                paths: "{{ item }}"
                age: "{{ temp_age_days }}d"
                recurse: true
                file_type: file
              loop: "{{ temp_dirs }}"
              register: old_temps

            - name: Delete old temp files
              no_log: true
              ansible.builtin.file:
                path: "{{ item.path }}"
                state: absent
              loop: "{{ old_temps.results | map(attribute='files') | sum(start=[]) }}"

            - name: Docker cleanup
              when: "'docker' in ansible_facts.packages"
              block:
                - name: Remove stopped containers
                  ansible.builtin.command: docker container prune -f
                  changed_when: false

                - name: Remove unused images
                  ansible.builtin.command: docker image prune -a -f
                  changed_when: false

                - name: Remove dangling volumes
                  ansible.builtin.command: docker volume prune -f
                  changed_when: false

                - name: Remove dangling networks
                  ansible.builtin.command: docker network prune -f
                  changed_when: false

                - name: Remove builder cache
                  ansible.builtin.command: docker builder prune -a -f
                  changed_when: false

            - name: Get current kernel version
              ansible.builtin.command: uname -r
              register: current_kernel
              changed_when: false

            - name: List installed kernels
              ansible.builtin.shell: |
                set -o pipefail
                dpkg -l | grep linux-image | awk '{print $2}'
              register: installed_kernels
              when: ansible_facts.pkg_mgr == 'apt'
              changed_when: false
              args:
                executable: /bin/bash

            - name: Remove old kernels
              when: ansible_facts.pkg_mgr == 'apt'
              ansible.builtin.apt:
                name: "{{ item }}"
                state: absent
                purge: true
              loop: "{{ installed_kernels.stdout_lines | reject('search', current_kernel.stdout) | list }}"

            - name: Update grub configuration
              when: ansible_facts.pkg_mgr == 'apt'
              ansible.builtin.command: update-grub
              changed_when: false

        - name: Get disk usage after cleanup
          ansible.builtin.shell: |
            set -o pipefail
            df -P {{ disk_path }} | awk 'NR==2 {gsub(/%/, "", $5); print $5}'
          register: disk_usage_after
          changed_when: false
          args:
            executable: /bin/bash

        - name: Show disk usage after
          ansible.builtin.debug:
            msg:
              - "Disk usage before: {{ disk_usage_before.stdout }}%"
              - "Disk usage after:  {{ disk_usage_after.stdout }}%"
